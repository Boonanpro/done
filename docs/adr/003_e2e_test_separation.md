# ADR-003: E2Eテストの分離とテスト用DB

## ステータス
採用（2024-12-27）

## 関連
- **Commits**: `f0df21c`
- **CHANGELOG**: [v1.3.0](../../CHANGELOG.md#130---2024-12-27)

## 背景・問題

WILLER高速バス予約の実機テストで、以下の問題が発生した：

```
モックテスト: ✅ 全てパス
実際に動かす: ❌ 多数のエラー
```

**発見された問題**：
1. PlaywrightのWindows asyncio互換性問題（`NotImplementedError`）
2. 文字エンコーディング問題（日本語が文字化け）
3. Executor選択ロジックのバグ
4. スクリーンショットが真っ白

**根本原因**：
> モックテストだけでは「嘘の安心感」を与えてしまう。
> 実際のサービスを動かさないと検出できない問題がある。

## 決定

1. **テストを2種類に分離**：
   - `tests/` - Unit Tests（モック、高速、毎コミット）
   - `tests_e2e/` - E2E Tests（実サービス、手動実行）

2. **テスト用DBを分離**：
   - 本番: `.env` → 本番Supabaseプロジェクト
   - テスト: `.env.test` → テスト用Supabaseプロジェクト

## 検討した代替案

| 案 | 内容 | 結論 |
|----|------|------|
| 全テストでPlaywright | 毎コミットで実行 | ❌ 遅すぎる（数分/回）|
| モックのみ | 高速だが問題検出不可 | ❌ 今回の問題を見逃す |
| **分離** | 毎コミット=モック、リリース前=E2E | ✅ 採用 |
| 本番DBでテスト | 設定不要 | ❌ データ汚染リスク |

## 分離の理由

### なぜテストDBを分けるか

```
本番DBでテストすると:

users:
  - 山田太郎（本物のユーザー）
  - test_user_001 ← テストで作成されたゴミ
  - test_user_002 ← テストで作成されたゴミ

→ 本番データが汚染される
```

### なぜE2Eを毎コミットで実行しないか

```
Unit Test: 50秒
E2E Test:  5分以上（ブラウザ起動、外部サービスアクセス）

毎コミット5分待ちは開発効率が著しく低下
```

## ディレクトリ構造

```
tests/                    ← 毎コミット実行（pre-commit hook）
  conftest.py             # モック設定
  test_api.py
  test_execution_engine.py

tests_e2e/                ← 手動・リリース前実行
  conftest.py             # 実サービス設定
  test_willer_booking.py  # WILLER予約E2E
```

## 実行方法

```bash
# Unit Tests（毎コミット）
pytest tests/ -v

# E2E Tests（手動）
cp env_test_example.txt .env.test  # テスト用DB設定
pytest tests_e2e/ -v --headed -m e2e
```

## 結果

- ✅ 毎コミットは高速（50秒）
- ✅ E2Eで実際の問題を検出可能
- ✅ 本番データ汚染を防止
- ✅ 外部サービス状態に依存しない日常開発

## 教訓

> 「テストが全部パスしている」は「本番で動く」を意味しない。
> 実際のサービスを動かすE2Eテストは、リリース前に必須。

