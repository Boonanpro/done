# ADR-002: LLMを使ったスマートフォールバック

## ステータス
採用（2024-12-27）

## 関連
- **Commits**: `69c5b9d`, `0ff8124`
- **CHANGELOG**: [v1.3.0](../../CHANGELOG.md#130---2024-12-27)

## 背景・問題

WILLER高速バス予約のE2Eテストで、12月30日の大阪→米子便が見つからなかった。

**以前の動作**：
```
ユーザー: 「12/30に大阪から米子へバス予約して」
システム: 「バスが見つかりませんでした」
→ 終了（代替案なし）
```

**問題点**：
1. ユーザーは「じゃあどうすればいいの？」と困る
2. 電車や新幹線など代替手段を自分で調べる必要がある
3. 目的は「米子に行くこと」であり「バスに乗ること」ではない

## 決定

タスク失敗時に**LLMが距離・コスト・利便性を考慮した代替案を生成**する。

```
ユーザー: 「12/30に大阪から米子へバス予約して」
    ↓
システム: バス検索 → 見つからない
    ↓
LLM: 距離200km、所要時間、コストを考慮して代替案生成
    ↓
システム: 「バスは見つかりませんでした。

📋 **代替案**:
🥇 **おすすめ**: 新幹線+特急やくも（岡山経由）約3時間 ¥12,000
🥈 **次点**: レンタカー（約4時間）¥8,000〜
🥉 **その他**: 日程を1日ずらしてバス再検索」
```

## 検討した代替案

| 案 | 内容 | 結論 |
|----|------|------|
| 単純なフォールバック | バスがだめなら電車を検索 | ❌ 距離を考慮しない |
| 固定リスト | 「電車、飛行機、タクシー」を常に表示 | ❌ 状況に合わない |
| **LLMで生成** | 距離・コスト・目的を考慮して提案 | ✅ 採用 |

## 実装詳細

```python
async def _generate_fallback_proposals(
    self, 
    wish: str, 
    task_type: TaskType,
    failed_action: str,
    error_message: str
) -> str:
    """LLMで代替案を生成"""
    prompt = f"""
    元のリクエスト: {wish}
    失敗した操作: {failed_action}
    
    距離・コスト・利便性を考慮して代替案を提案してください。
    🥇 おすすめ → 🥈 次点 → 🥉 その他 の形式で。
    """
    response = await self.llm.ainvoke(prompt)
    return response.content
```

## 対応タスクタイプ

| タスクタイプ | フォールバック例 |
|------------|----------------|
| TRAVEL | 電車、新幹線、飛行機、レンタカー |
| PURCHASE | 別ECサイト、類似商品、実店舗 |
| その他 | 目的達成のための創造的代替案 |

## 結果

- ✅ ユーザーは「次に何をすべきか」が分かる
- ✅ 距離に応じた適切な代替手段を提案
- ✅ 全タスクタイプで動作

