# Phase 3A: Smart Proposal（リアルタイム検索提案）

## 概要

現状の「テンプレ回答」から、**実際の情報を検索して具体的な提案をする**能力を追加する。

### Before（現状）
```
ユーザー：「12月28日に新大阪から博多まで新幹線予約したい」

Done：「EX予約で17:00発の新幹線を予約します」
      ↑ AIの推測（実在するかわからない）
```

### After（目標）
```
ユーザー：「12月28日に新大阪から博多まで新幹線予約したい」

Done：「以下の便が見つかりました：
      - 16:00発 のぞみ45号（空席あり）
      - 17:00発 のぞみ47号（空席あり）
      - 18:00発 のぞみ49号（残りわずか）
      
      17:00発を予約しますか？」
      ↑ 実際の検索結果に基づく提案
```

---

## ユースケース

| # | カテゴリ | ユーザーの願望 | 検索対象 |
|---|---------|--------------|---------|
| 1 | 交通 | 新幹線を予約したい | 乗り換え案内サービス |
| 2 | 交通 | 高速バスを予約したい | 高速バス検索サービス |
| 3 | 買い物 | PCを買いたい | EC検索（Amazon、楽天等） |
| 4 | 買い物 | 〇〇を探している | 価格比較サイト |
| 5 | 専門家 | 税理士を探したい | 税理士ドットコム等 |
| 6 | 専門家 | 弁護士を探したい | 弁護士ドットコム等 |
| 7 | 飲食 | レストランを予約したい | 食べログ、ホットペッパー等 |
| 8 | 汎用 | 〇〇について調べて | Web検索 |

---

## 技術スタック検討

### 現状の技術スタック

| カテゴリ | 技術 | 状態 |
|---------|------|------|
| AIエージェント | LangGraph + Claude | ✅ 実装済み |
| Web検索 | DuckDuckGo API | ⚠️ 実装済み、制限あり |
| ブラウザ自動化 | Playwright | ⚠️ 実装済み、未接続 |
| バックエンド | FastAPI | ✅ 実装済み |

### 新規追加が必要な技術

#### 1. Web検索API（必須）

| 選択肢 | 特徴 | 料金 | 推奨度 |
|--------|------|------|--------|
| **Tavily API** | AI向け最適化、構造化出力 | 1000回/月 無料 | ⭐⭐⭐ |
| SerpAPI | Google検索結果取得 | 100回/月 無料 | ⭐⭐ |
| Brave Search API | 高速、プライバシー重視 | 2000回/月 無料 | ⭐⭐ |
| Bing Search API | Microsoft公式 | 1000回/月 無料 | ⭐ |

**推奨: Tavily API**
- LangChain公式連携あり
- AI向けに構造化されたレスポンス
- 無料枠で開発・検証に十分

#### 2. 交通検索（Playwright統一）

交通手段ごとに最適なサービスをPlaywrightでスクレイピング：

| 交通手段 | 検索サービス | 取得できる情報 |
|---------|------------|--------------|
| **電車・新幹線** | Yahoo!乗換案内 / ジョルダン | 時刻、料金、乗り換え |
| **高速バス** | 高速バスネット / 楽天トラベル | 時刻、料金、空席 |
| **航空機** | スカイスキャナー / Google Flights | 便名、料金、空席 |

**推奨: Playwright + 各サービス直接スクレイピング**
- 電車・新幹線: Yahoo!乗換案内（時刻・料金）
- 高速バス: 高速バスネット（時刻・料金・空席）
- 航空機: スカイスキャナー（便名・料金・空席）
- Phase 3B（実行）と技術スタックが統一される

**将来の拡張オプション:**
- 駅すぱあとAPI（電車・新幹線の公式API）
- NAVITIME API（総合交通API）

#### 3. EC検索（Playwright統一）

特定のAPIに依存せず、どのECサイトでも対応可能な設計：

| ECサイト | スクレイピング対象 | 取得できる情報 |
|---------|------------------|--------------|
| **価格.com** | 価格比較ページ | 商品名、価格、複数ショップ比較 |
| **Amazon** | 検索結果ページ | 商品名、価格、レビュー |
| **楽天市場** | 検索結果ページ | 商品名、価格、ポイント |
| **ヨドバシ.com** | 検索結果ページ | 商品名、価格、在庫 |

**推奨: Playwright + 各サイト直接スクレイピング**
- どのECサイトでも購入可能（楽天限定にならない）
- Phase 3B（実行）と技術スタックが統一される
- 価格比較も可能

**メリット:**
- ✅ Amazon、楽天、ヨドバシ等どこでも対応
- ✅ 価格比較して最安値を提案可能
- ✅ 実行時も同じPlaywrightを使用（統一されたアーキテクチャ）

**デメリット:**
- ⚠️ サイト構造変更時にセレクタ修正が必要
- ⚠️ APIより実行速度が遅い（ブラウザ起動が必要）

#### 4. スクレイピング基盤（汎用）

| 選択肢 | 特徴 | 料金 | 推奨度 |
|--------|------|------|--------|
| **Playwright（既存）** | フル機能ブラウザ | 無料 | ⭐⭐⭐ |
| Firecrawl | AIフレンドリー出力 | 500ページ/月 無料 | ⭐⭐ |
| Browserbase | クラウドブラウザ | 100時間/月 無料 | ⭐⭐ |

**推奨: Playwright（既存活用）**
- 既に実装済み
- ローカル実行で制限なし

---

## 推奨技術スタック（最終）

| レイヤー | 技術 | 理由 |
|---------|------|------|
| **AI推論** | Claude (Anthropic) | 既存、高品質 |
| **エージェント** | LangGraph | 既存、ツール呼び出し対応 |
| **汎用検索** | Tavily API | AI向け最適化、無料枠あり |
| **EC検索** | Playwright + 各ECサイト | どこでも対応可能、Phase 3Bと統一 |
| **交通検索** | Playwright + 各交通サービス | 電車・バス・航空機対応、Phase 3Bと統一 |
| **汎用スクレイピング** | Playwright | 既存、フル機能 |
| **キャッシュ** | Redis（既存） | 検索結果キャッシュ |

### 交通検索の対応サービス

| 交通手段 | サービス | URL |
|---------|---------|-----|
| 電車・新幹線 | Yahoo!乗換案内 | transit.yahoo.co.jp |
| 高速バス | 高速バスネット | www.kousokubus.net |
| 航空機 | スカイスキャナー | www.skyscanner.jp |

### EC検索の対応サイト

| サイト | 特徴 | URL |
|-------|------|-----|
| 価格.com | 価格比較、最安値検索 | kakaku.com |
| Amazon | 品揃え豊富、レビュー充実 | amazon.co.jp |
| 楽天市場 | ポイント還元 | rakuten.co.jp |
| ヨドバシ.com | 家電、即日配送 | yodobashi.com |

---

## アーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                        ユーザー                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    POST /api/v1/wish                        │
│                    「新幹線を予約したい」                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    AIエージェント（LangGraph）                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. 意図解析                                         │   │
│  │     「新幹線予約」→ TaskType.TRAVEL                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                              ▼                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  2. 情報収集ツール選択                                │   │
│  │     travel_search / product_search / web_search      │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                              ▼                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  3. リアルタイム検索実行                              │   │
│  │     - 電車・新幹線: Yahoo!乗換案内（Playwright）       │   │
│  │     - 高速バス: 高速バスネット（Playwright）           │   │
│  │     - 航空機: スカイスキャナー（Playwright）           │   │
│  │     - EC: 価格.com/Amazon/楽天等（Playwright）        │   │
│  │     - 汎用: Tavily検索（API）                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                              │                              │
│                              ▼                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  4. 結果を基に提案生成                                │   │
│  │     実データに基づく具体的な提案                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  レスポンス                                                  │
│  {                                                          │
│    "task_id": "uuid",                                       │
│    "proposed_actions": ["17:00発 のぞみ47号を予約"],          │
│    "search_results": [                                      │
│      {                                                      │
│        "id": "train_001",                                   │
│        "category": "train",                                 │
│        "title": "のぞみ45号 16:00発",                        │
│        "url": "https://expy.jp/reserve/...",                │
│        "price": 14500,                                      │
│        "status": "○",                                       │
│        "details": {"departure": "新大阪", "arrival": "博多"},│
│        "execution_params": {"service": "ex_reservation"}    │
│      },                                                     │
│      ...                                                    │
│    ],                                                       │
│    "proposal_detail": "..."                                 │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 実装ステップ

### Step 0: 基盤準備

| # | タスク | 説明 |
|---|--------|------|
| 0-1 | Tavily API キー取得 | https://tavily.com でアカウント作成 |
| 0-2 | 環境変数追加 | `.env` に API キーを追加 |
| 0-3 | 設定クラス更新 | `app/config.py` に新しい設定追加 |

### Step 1: 検索ツール実装

| # | タスク | 説明 |
|---|--------|------|
| 1-1 | `tavily_search.py` | Tavily API連携ツール（汎用検索） |
| 1-2 | `travel_search.py` | 交通検索ツール（Playwright） |
| 1-3 | `product_search.py` | EC商品検索ツール（Playwright） |
| 1-4 | ツール登録 | `app/tools/__init__.py` に追加 |

#### 交通検索ツール詳細

| サブツール | 対象サービス | 機能 |
|-----------|------------|------|
| `search_train` | Yahoo!乗換案内 | 電車・新幹線の時刻・料金検索 |
| `search_bus` | 高速バスネット | 高速バスの時刻・料金・空席検索 |
| `search_flight` | スカイスキャナー | 航空便の便名・料金・空席検索 |

#### EC検索ツール詳細

| サブツール | 対象サイト | 機能 |
|-----------|----------|------|
| `search_product_kakaku` | 価格.com | 価格比較、最安値検索 |
| `search_product_amazon` | Amazon | 商品検索、レビュー取得 |
| `search_product_rakuten` | 楽天市場 | 商品検索、ポイント情報 |

### Step 2: エージェント改修

| # | タスク | 説明 |
|---|--------|------|
| 2-1 | 提案時ツール有効化 | `_propose_actions` でツール使用 |
| 2-2 | 検索結果の構造化 | `search_results` をレスポンスに追加 |
| 2-3 | プロンプト改善 | 検索結果を使った提案生成 |

### Step 3: API拡張

| # | タスク | 説明 |
|---|--------|------|
| 3-1 | レスポンス形式更新 | `search_results` フィールド追加 |
| 3-2 | キャッシュ実装 | 同一検索結果のキャッシュ |
| 3-3 | エラーハンドリング | 検索失敗時のフォールバック |

### Step 4: テスト・検証

| # | タスク | 説明 |
|---|--------|------|
| 4-1 | 単体テスト | 各検索ツールのテスト |
| 4-2 | 統合テスト | エージェント経由のテスト |
| 4-3 | 手動テスト | 各ユースケースの動作確認 |

---

## ファイル構成（新規・変更）

```
app/
├── config.py                    # 変更: 新API設定追加
├── tools/
│   ├── __init__.py              # 変更: 新ツール登録
│   ├── search.py                # 既存（DuckDuckGo）→ 将来削除予定
│   ├── tavily_search.py         # 新規: Tavily汎用検索
│   ├── travel_search.py         # 新規: 交通検索（電車・バス・航空機）
│   ├── product_search.py        # 新規: EC商品検索（価格.com/Amazon/楽天等）
│   └── browser.py               # 既存（Playwright）→ 共通基盤として活用
├── agent/
│   └── agent.py                 # 変更: 提案時にツール使用
└── models/
    └── schemas.py               # 変更: SearchResult追加
```

---

## 環境変数（追加）

```env
# Tavily API（汎用検索用）
TAVILY_API_KEY=tvly-xxxxx
```

**注意:** EC検索・交通検索はPlaywrightスクレイピングのため、追加のAPIキーは不要です。

---

## 成功基準

| # | 基準 | 検証方法 |
|---|------|---------|
| 1 | 電車・新幹線検索で実際の便が表示される | 手動テスト |
| 2 | 高速バス検索で実際の便が表示される | 手動テスト |
| 3 | 航空機検索で実際の便が表示される | 手動テスト |
| 4 | 商品検索で実際の商品（複数サイト）が表示される | 手動テスト |
| 5 | 汎用検索で関連情報が表示される | 手動テスト |
| 6 | 検索失敗時もエラーにならない（フォールバック） | 自動テスト |
| 7 | レスポンス時間が10秒以内（Playwright使用のため緩和） | 自動テスト |

---

## リスクと対策

| リスク | 対策 |
|--------|------|
| スクレイピング対象サイトの構造変更 | セレクタを設定ファイル化、定期的な動作確認 |
| API利用制限超過 | キャッシュ実装、レート制限 |
| 検索結果が見つからない | フォールバック（テンプレ回答）を維持 |
| レスポンス遅延 | 並列検索、タイムアウト設定 |

---

## 次のフェーズ

Phase 3A 完了後、**Phase 3B: Execution Engine**（承認後の実行）に進む。

- Phase 3A: 検索して提案する ← 今回
- Phase 3B: 承認後に実行する（予約・購入を実際に行う）
